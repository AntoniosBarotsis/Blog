<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Testing an ASP .NET Core project | My Blog</title>
<meta name=keywords content="Csharp,CI,Testing,Github Actions">
<meta name=description content="Tests and automated coverage reports with .NET and Github actions">
<meta name=author content="Theme PaperMod">
<link rel=canonical href=https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/>
<link crossorigin=anonymous href=/Blog/assets/css/stylesheet.min.59067c5d74184c7b3fcf83bf4c654c92e1d67005c1054ed4e55e054c277110e3.css integrity="sha256-WQZ8XXQYTHs/z4O/TGVMkuHWcAXBBU7U5V4FTCdxEOM=" rel="preload stylesheet" as=style>
<link rel=icon href=https://antoniosbarotsis.github.io/Blog/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://antoniosbarotsis.github.io/Blog/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://antoniosbarotsis.github.io/Blog/favicon-32x32.png>
<link rel=apple-touch-icon href=https://antoniosbarotsis.github.io/Blog/apple-touch-icon.png>
<link rel=mask-icon href=https://antoniosbarotsis.github.io/Blog/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<meta property="og:title" content="Testing an ASP .NET Core project">
<meta property="og:description" content="Tests and automated coverage reports with .NET and Github actions">
<meta property="og:type" content="article">
<meta property="og:url" content="https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/">
<meta property="og:image" content="https://antoniosbarotsis.github.io/Blog/images/x.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-29T16:12:35+02:00">
<meta property="article:modified_time" content="2021-10-29T16:12:35+02:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://antoniosbarotsis.github.io/Blog/images/x.png">
<meta name=twitter:title content="Testing an ASP .NET Core project">
<meta name=twitter:description content="Tests and automated coverage reports with .NET and Github actions">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://antoniosbarotsis.github.io/Blog/posts/"},{"@type":"ListItem","position":2,"name":"Testing an ASP .NET Core project","item":"https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing an ASP .NET Core project","name":"Testing an ASP .NET Core project","description":"Tests and automated coverage reports with .NET and Github actions","keywords":["Csharp","CI","Testing","Github Actions"],"articleBody":"Introduction Most Web API templates I could find online do not have testing pre configured in them and the official ones do not have it at all so I thought that I would make a post about setting up basic unit tests as well as mocking dependencies.\nI will be using XUnit which is one of the most used testing frameworks for .NET as well as FakeItEasy for mocking. In the end I will also use Coverlet and Codecov for coverage reports.\nThe API will be the weather forecast template with the addition of a service layer which is what we will be testing. Let’s get started!\nCoding Creating the project I will be creating a solution with 2 projects, one being the API and the other one being the one for testing.\nWe start by creating a folder for the solution:\nmkdir TestingAPI cd TestingAPI dotnet new sln We can now create the API project and add it to our solution:\ndotnet new webapi -n src dotnet sln add src/src.csproj Similarly for our test project:\ndotnet new xunit -n test dotnet sln add test/test.csproj Running dotnet run --project src should spin up the server and sure enough, visiting https://localhost:5001/weatherforecast returns us the expected responce.\nCreating the service I will create a Services folder and inside it add 2 files: a service interface and its implementation\n// IMyDependency.cs using System.Threading.Tasks; namespace src.Services { public interface IMyDependency { Taskstring GetDataFromDatabaseAsync(); } } // MyDependency.cs using System.Threading.Tasks; namespace src.Services { public class MyDependency: IMyDependency { public Taskstring GetDataFromDatabaseAsync() { return Task.FromResult(\"Hello From MyDependency!\"); } } } Let’s head to our controller and make use of the service we just created there so we can make sure it works:\n// WeatherForecastController.cs // ... private readonly ILogger _logger; private readonly IMyDependency _dependency; public WeatherForecastController(ILogger logger, IMyDependency dependency) { _logger = logger; _dependency = dependency; } // ... [HttpGet] public async Task Get() { _logger.LogInformation(await _dependency.GetDataFromDatabaseAsync()); // No changes below this  var rng = new Random(); return Enumerable.Range(1, 5).Select(index = new WeatherForecast { Date = DateTime.Now.AddDays(index), TemperatureC = rng.Next(-20, 55), Summary = Summaries[rng.Next(Summaries.Length)] }) .ToArray(); } Lastly we head to Startup.cs to register the implementation\n// Startup.cs public void ConfigureServices(IServiceCollection services) { services.AddScoped(); // ... } If we now run the app and hit the endpoint we should see Hello From MyDependency! logged in the console.\nWriting our tests Let’s navigate to our test project and write our first test\n// UnitTest1.cs using System.Threading.Tasks; using FakeItEasy; using src.Services; using Xunit; namespace test { public class UnitTest1 { [Fact] public async Task Test1() { var myDependency = new MyDependency(); Assert.Equal(\"Hello From MyDependency!\", await myDependency.GetDataFromDatabaseAsync()); } } } Here I changed the return type from void to async Task since the method we want to test is async. Running the test with dotnet test passes but this is not what we want.\nIn a normal project this method could require a database connection that we probably do not want to make use of in our tests for various reasons. This is where mocking comes into play; we can provide a fake implementation to our service methods. It might not be as apparent here why this could be useful so let me explain.\nUsually the way I like to structure my apps is to split them into 3 layers\n Controllers: handle http requests, call service layer Services: business logic, call repository layer Repositories: Handle database queries  Coming from a Spring Boot background, my terminology might be a bit different than what is normally used for .NET projects but the idea is the same; split your logic into layers and use dependency injection to interact between them.\nThe most important layer to test is the service layer since that’s where all the actual “programming” is. In order to test that I would have to mock my repository interface and have it return arbitrary fake data without actually using the database. You can imagine how bad of an idea it would be if someone was to test creations, updates or deletions while using the actual database…\nThere are some other options such as using a different, in memory database for testing but we will not be covering that in this post.\nSo back to our test, how do we mock the dependency?\n// UnitTest1.cs using System.Threading.Tasks; using FakeItEasy; using src.Services; using Xunit; namespace test { public class UnitTest1 { [Fact] public async Task Test1() { var myDependency = new MyDependency(); Assert.Equal(\"Hello From MyDependency!\", await myDependency.GetDataFromDatabaseAsync()); } [Fact] public async Task Test2() { var myDependency = A.Fake(); A.CallTo(() = myDependency.GetDataFromDatabaseAsync()).Returns(Task.FromResult(\"Hello from mocked\")); Assert.Equal(\"Hello from mocked\", await myDependency.GetDataFromDatabaseAsync()); } } } Using the FakeItEasy package we define an instance of the IMyDependency interface using A.Fake. This right now does nothing; we have to explicitly define what happens when one of the interface methods gets called, we do that with A.CallTo which accepts a lambda of the method in question. I am using Task.FromResult because the method is async. If we run the test we can see that it passes which means that we successfully changed the “implementation” of our dependency. Again, this is what would normally be a repository and a database call changed to hard coded data, similar to what would be returned from said database call.\nAdding a CI pipeline with Codecov Another thing we could do is add Codecov to get a detailed view of our test coverage. The best way to do that in my opinion is to create a Continuous Integration (CI) pipeline on Github that will generate and push code coverage information everytime we update the repository.\nFirst go to Codecov’s website and create an account. Get your CODECOV_TOKEN and create a repository secret with its value on your github repository, we will be using this later when we push our data to Codecov.\nWe also need to create a codecov.yml file with some basic configuration. Here’s what I had from a previous project:\n# codecov.yml comment: false ignore: - \"^(?!.*Services).*$\" coverage: status: project: default: target: auto threshold: 1% informational: true patch: default: target: auto threshold: 1% informational: true The only interesting thing about this is that I ignored every folder that does not include Services since that’s the only thing we tested.\nLet’s create the .github/workflows/dotnet.yml file and use the Github Actions template for .NET apps which includes building and testing. We only have to add one more step for codecov to work:\n# dotnet.yml name: .NET on: push: branches: [ master ] pull_request: branches: [ master ] jobs: build: runs-on: ubuntu-latest steps: - uses: actions/checkout@v2 - name: Setup .NET uses: actions/setup-dotnet@v1 with: dotnet-version: 5.0.x - name: Restore dependencies run: dotnet restore - name: Build run: dotnet build --no-restore - name: Test run: dotnet test --no-build --verbosity normal --collect:\"XPlat Code Coverage\" -- IncludeDirectory=\"[.]*Services[.]*\" - name: Codecov uses: codecov/codecov-action@v2 with: token: ${{ secrets.CODECOV_TOKEN }} The Codecov action offers a few useful parameters for you to use so if you are interested, read their docs!\nWith all this done and pushed you just want to wait for the Action to complete. After that’s done I can take a look at my coverage\nThis is very useful to look at when dealing when more than one directory unlike here.\nYou can also take a look at the exact spots in your code that you tested/missed\nAnd finally (but certainly most importantly), codecov gives you a badge to display on your Github repo to show everyone how well tested your code is. What’s the point of testing if you don’t let everyone know you did after all?\nConclusion Testing is basically essential to any application that is not yet another personal project doomed to be abandoned a few weeks after its inception. If you decide to test your project I do not see why you wouldn’t include coverage reports, whether automated or not. Codecov (and other similar tools) allow you to set a lot of rules that would fail your pipeline if not met such as: minimum coverage, a minimum threshold of allowed coverage drop on new commits and a lot more.\nI hope you got something out of this post and thanks for reading! :)\nYou can find the code here.\n","wordCount":"1364","inLanguage":"en","image":"https://antoniosbarotsis.github.io/Blog/images/x.png","datePublished":"2021-10-29T16:12:35+02:00","dateModified":"2021-10-29T16:12:35+02:00","author":{"@type":"Person","name":"Theme PaperMod"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/"},"publisher":{"@type":"Organization","name":"My Blog","logo":{"@type":"ImageObject","url":"https://antoniosbarotsis.github.io/Blog/favicon.ico"}}}</script>
</head>
<body id=top>
<script>window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://antoniosbarotsis.github.io/Blog/ accesskey=h title="My Blog (Alt + H)">My Blog</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://antoniosbarotsis.github.io/Blog/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://antoniosbarotsis.github.io/Blog/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://antoniosbarotsis.github.io/Blog/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://antoniosbarotsis.github.io/Blog/>Home</a>&nbsp;»&nbsp;<a href=https://antoniosbarotsis.github.io/Blog/posts/>Posts</a></div>
<h1 class=post-title>
Testing an ASP .NET Core project
</h1>
<div class=post-description>
Tests and automated coverage reports with .NET and Github actions
</div>
<div class=post-meta>October 29, 2021&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href="https://github.com/AntoniosBarotsis/Blog/tree/master/content
/
posts/aspnet_testing/index.md" rel="noopener noreferrer" target=_blank>Suggest Changes</a></div>
</header>
<figure class=entry-cover>
<img loading=lazy srcset="https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/images/x_hu996c083257ac3745a1b8884b50135f7f_10890_360x0_resize_box_3.png 360w ,https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/images/x_hu996c083257ac3745a1b8884b50135f7f_10890_480x0_resize_box_3.png 480w ,https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/images/x_hu996c083257ac3745a1b8884b50135f7f_10890_720x0_resize_box_3.png 720w ,https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/images/x.png 850w" sizes="(min-width: 768px) 720px, 100vw" src=https://antoniosbarotsis.github.io/Blog/posts/aspnet_testing/images/x.png alt>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>Table of Contents</div>
</summary>
<div class=inner><ul>
<li>
<a href=#introduction aria-label=Introduction>Introduction</a></li>
<li>
<a href=#coding aria-label=Coding>Coding</a><ul>
<li>
<a href=#creating-the-project aria-label="Creating the project">Creating the project</a></li>
<li>
<a href=#creating-the-service aria-label="Creating the service">Creating the service</a></li>
<li>
<a href=#writing-our-tests aria-label="Writing our tests">Writing our tests</a></li>
<li>
<a href=#adding-a-ci-pipeline-with-codecov aria-label="Adding a CI pipeline with Codecov">Adding a CI pipeline with Codecov</a></li></ul>
</li>
<li>
<a href=#conclusion aria-label=Conclusion>Conclusion</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1>
<p>Most Web API templates I could find online do not have testing pre configured in them and the official ones do not have it at all so I thought
that I would make a post about setting up basic unit tests as well as mocking dependencies.</p>
<p>I will be using <a href=https://xunit.net/>XUnit</a> which is one of the most used testing frameworks for .NET as well as
<a href=https://fakeiteasy.github.io/>FakeItEasy</a> for mocking. In the end I will also use <a href=https://dotnetfoundation.org/projects/coverlet>Coverlet</a>
and <a href=https://about.codecov.io/>Codecov</a> for coverage reports.</p>
<p>The API will be the weather forecast template with the addition of a service layer which is what we will be testing. Let&rsquo;s get started!</p>
<h1 id=coding>Coding<a hidden class=anchor aria-hidden=true href=#coding>#</a></h1>
<h2 id=creating-the-project>Creating the project<a hidden class=anchor aria-hidden=true href=#creating-the-project>#</a></h2>
<p>I will be creating a solution with 2 projects, one being the API and the other one being the one for testing.</p>
<p>We start by creating a folder for the solution:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir TestingAPI
cd TestingAPI
dotnet new sln
</code></pre></div><p>We can now create the API project and add it to our solution:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dotnet new webapi -n src
dotnet sln add src/src.csproj
</code></pre></div><p>Similarly for our test project:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dotnet new xunit -n test
dotnet sln add test/test.csproj
</code></pre></div><p>Running <code>dotnet run --project src</code> should spin up the server and sure enough, visiting <code>https://localhost:5001/weatherforecast</code>
returns us the expected responce.</p>
<h2 id=creating-the-service>Creating the service<a hidden class=anchor aria-hidden=true href=#creating-the-service>#</a></h2>
<p>I will create a <code>Services</code> folder and inside it add 2 files: a service interface and its implementation</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// IMyDependency.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System.Threading.Tasks;

<span style=color:#66d9ef>namespace</span> src.Services
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> IMyDependency
    {
        Task&lt;<span style=color:#66d9ef>string</span>&gt; GetDataFromDatabaseAsync();
    }
}
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// MyDependency.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System.Threading.Tasks;

<span style=color:#66d9ef>namespace</span> src.Services
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyDependency</span>: IMyDependency
    {
        <span style=color:#66d9ef>public</span> Task&lt;<span style=color:#66d9ef>string</span>&gt; GetDataFromDatabaseAsync()
        {
            <span style=color:#66d9ef>return</span> Task.FromResult(<span style=color:#e6db74>&#34;Hello From MyDependency!&#34;</span>);
        }
    }
}
</code></pre></div><p>Let&rsquo;s head to our controller and make use of the service we just created there so we can make sure it works:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// WeatherForecastController.cs
</span><span style=color:#75715e>// ...
</span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger&lt;WeatherForecastController&gt; <span style=color:#ae81ff>_l</span>ogger;
<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IMyDependency <span style=color:#ae81ff>_d</span>ependency;

<span style=color:#66d9ef>public</span> WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger, IMyDependency dependency)
{
    <span style=color:#ae81ff>_l</span>ogger = logger;
    <span style=color:#ae81ff>_d</span>ependency = dependency;
}
<span style=color:#75715e>// ...
</span><span style=color:#75715e></span><span style=color:#a6e22e>
</span><span style=color:#a6e22e>[HttpGet]</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IEnumerable&lt;WeatherForecast&gt;&gt; Get()
{
    <span style=color:#ae81ff>_l</span>ogger.LogInformation(<span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_d</span>ependency.GetDataFromDatabaseAsync());
    
    <span style=color:#75715e>// No changes below this
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> rng = <span style=color:#66d9ef>new</span> Random();
    <span style=color:#66d9ef>return</span> Enumerable.Range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5</span>).Select(index =&gt; <span style=color:#66d9ef>new</span> WeatherForecast
    {
        Date = DateTime.Now.AddDays(index),
        TemperatureC = rng.Next(-<span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>55</span>),
        Summary = Summaries[rng.Next(Summaries.Length)]
    })
    .ToArray();
}
</code></pre></div><p>Lastly we head to <code>Startup.cs</code> to register the implementation</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// Startup.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ConfigureServices(IServiceCollection services)
{
    services.AddScoped&lt;IMyDependency, MyDependency&gt;();
    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>If we now run the app and hit the endpoint we should see <code>Hello From MyDependency!</code> logged in the console.</p>
<h2 id=writing-our-tests>Writing our tests<a hidden class=anchor aria-hidden=true href=#writing-our-tests>#</a></h2>
<p>Let&rsquo;s navigate to our test project and write our first test</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// UnitTest1.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> FakeItEasy;
<span style=color:#66d9ef>using</span> src.Services;
<span style=color:#66d9ef>using</span> Xunit;

<span style=color:#66d9ef>namespace</span> test
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnitTest1</span>
    {
<span style=color:#a6e22e>        [Fact]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Test1()
        {
            <span style=color:#66d9ef>var</span> myDependency = <span style=color:#66d9ef>new</span> MyDependency();
            Assert.Equal(<span style=color:#e6db74>&#34;Hello From MyDependency!&#34;</span>, <span style=color:#66d9ef>await</span> myDependency.GetDataFromDatabaseAsync());
        }
    }
}
</code></pre></div><p>Here I changed the return type from <code>void</code> to <code>async Task</code> since the method we want to test is async. Running the test with
<code>dotnet test</code> passes but this is not what we want.</p>
<p>In a normal project this method could require a database connection that we probably do not want to make use of in our tests for various reasons.
This is where mocking comes into play; we can provide a fake implementation to our service methods. It might not be as apparent here why this could
be useful so let me explain.</p>
<p>Usually the way I like to structure my apps is to split them into 3 layers</p>
<ul>
<li>Controllers: handle http requests, call service layer</li>
<li>Services: business logic, call repository layer</li>
<li>Repositories: Handle database queries</li>
</ul>
<p>Coming from a Spring Boot background, my terminology might be a bit different than what is normally used for .NET projects but the idea is the same;
split your logic into layers and use dependency injection to interact between them.</p>
<p>The most important layer to test is the service layer since that&rsquo;s where all the actual &ldquo;programming&rdquo; is. In order to test that I would have to mock
my repository interface and have it return arbitrary fake data without actually using the database. You can imagine how bad of an idea it would be
if someone was to test creations, updates or deletions while using the actual database&mldr;</p>
<p>There are some other options such as using a different, in memory database for testing but we will not be covering that in this post.</p>
<p>So back to our test, how do we mock the dependency?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// UnitTest1.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> FakeItEasy;
<span style=color:#66d9ef>using</span> src.Services;
<span style=color:#66d9ef>using</span> Xunit;

<span style=color:#66d9ef>namespace</span> test
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnitTest1</span>
    {
<span style=color:#a6e22e>        [Fact]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Test1()
        {
            <span style=color:#66d9ef>var</span> myDependency = <span style=color:#66d9ef>new</span> MyDependency();
            Assert.Equal(<span style=color:#e6db74>&#34;Hello From MyDependency!&#34;</span>, <span style=color:#66d9ef>await</span> myDependency.GetDataFromDatabaseAsync());
        }
<span style=color:#a6e22e>        
</span><span style=color:#a6e22e>        [Fact]</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Test2()
        {
            <span style=color:#66d9ef>var</span> myDependency = A.Fake&lt;IMyDependency&gt;();
            A.CallTo(() =&gt; myDependency.GetDataFromDatabaseAsync()).Returns(Task.FromResult(<span style=color:#e6db74>&#34;Hello from mocked&#34;</span>));
            
            Assert.Equal(<span style=color:#e6db74>&#34;Hello from mocked&#34;</span>, <span style=color:#66d9ef>await</span> myDependency.GetDataFromDatabaseAsync());
        }
    }
}
</code></pre></div><p>Using the <code>FakeItEasy</code> package we define an instance of the <code>IMyDependency</code> interface using <code>A.Fake</code>. This right now does nothing;
we have to explicitly define what happens when one of the interface methods gets called, we do that with <code>A.CallTo</code> which accepts a lambda
of the method in question. I am using <code>Task.FromResult</code> because the method is async. If we run the test we can see that it passes which means that
we successfully changed the &ldquo;implementation&rdquo; of our dependency. Again, this is what would normally be a repository and a database call changed to
hard coded data, similar to what would be returned from said database call.</p>
<h2 id=adding-a-ci-pipeline-with-codecov>Adding a CI pipeline with Codecov<a hidden class=anchor aria-hidden=true href=#adding-a-ci-pipeline-with-codecov>#</a></h2>
<p>Another thing we could do is add Codecov to get a detailed view of our test coverage. The best way to do that in my
opinion is to create a Continuous Integration (CI) pipeline on Github that will generate and push code coverage information everytime we update
the repository.</p>
<p>First go to Codecov&rsquo;s website and create an account. Get your <code>CODECOV_TOKEN</code> and create a repository secret with its value on your github
repository, we will be using this later when we push our data to Codecov.</p>
<p>We also need to create a <code>codecov.yml</code> file with some basic configuration. Here&rsquo;s what I had from a previous project:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#75715e># codecov.yml</span>
<span style=color:#f92672>comment</span>: <span style=color:#66d9ef>false</span>

<span style=color:#f92672>ignore</span>:
  - <span style=color:#e6db74>&#34;^(?!.*Services).*$&#34;</span>

<span style=color:#f92672>coverage</span>:
  <span style=color:#f92672>status</span>:
    <span style=color:#f92672>project</span>:
      <span style=color:#f92672>default</span>:
        <span style=color:#f92672>target</span>: <span style=color:#ae81ff>auto</span>
        <span style=color:#f92672>threshold</span>: <span style=color:#ae81ff>1</span><span style=color:#ae81ff>%</span>
        <span style=color:#f92672>informational</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>patch</span>:
      <span style=color:#f92672>default</span>:
        <span style=color:#f92672>target</span>: <span style=color:#ae81ff>auto</span>
        <span style=color:#f92672>threshold</span>: <span style=color:#ae81ff>1</span><span style=color:#ae81ff>%</span>
        <span style=color:#f92672>informational</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>The only interesting thing about this is that I ignored every folder that does not include <code>Services</code> since that&rsquo;s the only thing we tested.</p>
<p>Let&rsquo;s create the <code>.github/workflows/dotnet.yml</code> file and use the Github Actions template for .NET apps which includes building and testing.
We only have to add one more step for codecov to work:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#75715e># dotnet.yml</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>.NET</span>

<span style=color:#f92672>on</span>:
  <span style=color:#f92672>push</span>:
    <span style=color:#f92672>branches</span>: [ <span style=color:#ae81ff>master ]</span>
  <span style=color:#f92672>pull_request</span>:
    <span style=color:#f92672>branches</span>: [ <span style=color:#ae81ff>master ]</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>build</span>:

    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>

    <span style=color:#f92672>steps</span>:
    - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup .NET</span>
      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-dotnet@v1</span>
      <span style=color:#f92672>with</span>:
        <span style=color:#f92672>dotnet-version</span>: <span style=color:#ae81ff>5.0</span><span style=color:#ae81ff>.x</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Restore dependencies</span>
      <span style=color:#f92672>run</span>: <span style=color:#ae81ff>dotnet restore</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build</span>
      <span style=color:#f92672>run</span>: <span style=color:#ae81ff>dotnet build --no-restore</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Test</span>
      <span style=color:#f92672>run</span>: <span style=color:#ae81ff>dotnet test --no-build --verbosity normal --collect:&#34;XPlat Code Coverage&#34; -- IncludeDirectory=&#34;[.]*Services[.]*&#34;</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Codecov</span>
      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>codecov/codecov-action@v2</span>
      <span style=color:#f92672>with</span>:
        <span style=color:#f92672>token</span>: <span style=color:#ae81ff>${{ secrets.CODECOV_TOKEN }}</span>
</code></pre></div><p>The <a href=https://github.com/codecov/codecov-action>Codecov action</a> offers a few useful parameters for you to use so if you are interested,
read their docs!</p>
<p>With all this done and pushed you just want to wait for the Action to complete. After that&rsquo;s done I can take a look at my coverage</p>
<p><img loading=lazy src=images/codecov.png#center alt=codecov>
</p>
<p>This is very useful to look at when dealing when <em>more than one directory unlike here</em>.</p>
<p>You can also take a look at the exact spots in your code that you tested/missed</p>
<p><img loading=lazy src=images/code.png#center alt=code>
</p>
<p>And finally (but certainly most importantly), codecov gives you a badge to display on your Github repo to show everyone how well tested your code
is. What&rsquo;s the point of testing if you don&rsquo;t let everyone know you did after all?</p>
<h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1>
<p>Testing is basically essential to any application that is not yet another personal project doomed to be abandoned a few weeks after its inception.
If you decide to test your project I do not see why you wouldn&rsquo;t include coverage reports, whether automated or not. Codecov (and other similar tools)
allow you to set a lot of rules that would fail your pipeline if not met such as: minimum coverage, a minimum threshold of allowed coverage drop on new
commits and a lot more.</p>
<p>I hope you got something out of this post and thanks for reading! :)</p>
<p>You can find the code <a href=https://github.com/AntoniosBarotsis/TestingAPI>here</a>.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/csharp/>Csharp</a></li>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/ci/>CI</a></li>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/testing/>Testing</a></li>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/github-actions/>Github Actions</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://antoniosbarotsis.github.io/Blog/posts/cs_elk/>
<span class=title>Next Page »</span>
<br>
<span>C# and the ELK stack</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Testing an ASP .NET Core project on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20an%20ASP%20.NET%20Core%20project&url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f&hashtags=Csharp%2cCI%2cTesting%2cGithubActions"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Testing an ASP .NET Core project on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f&title=Testing%20an%20ASP%20.NET%20Core%20project&summary=Testing%20an%20ASP%20.NET%20Core%20project&source=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Testing an ASP .NET Core project on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f&title=Testing%20an%20ASP%20.NET%20Core%20project"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Testing an ASP .NET Core project on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Testing an ASP .NET Core project on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20an%20ASP%20.NET%20Core%20project%20-%20https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Testing an ASP .NET Core project on telegram" href="https://telegram.me/share/url?text=Testing%20an%20ASP%20.NET%20Core%20project&url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2faspnet_testing%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://utteranc.es/client.js repo=AntoniosBarotsis/Blog issue-term=pathname label=Comment theme=github-dark crossorigin=anonymous async></script>
</article>
</main>
</body>
</html>