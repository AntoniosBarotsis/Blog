<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>C# and the ELK stack | My Blog</title>
<meta name=keywords content="Csharp,Elasticsearch,Kibana,Monitoring">
<meta name=description content="Integrating the ELK stack with C#">
<meta name=author content="Antonios Barotsis">
<link rel=canonical href=https://antoniosbarotsis.github.io/Blog/posts/cs_elk/>
<link crossorigin=anonymous href=/Blog/assets/css/stylesheet.min.59067c5d74184c7b3fcf83bf4c654c92e1d67005c1054ed4e55e054c277110e3.css integrity="sha256-WQZ8XXQYTHs/z4O/TGVMkuHWcAXBBU7U5V4FTCdxEOM=" rel="preload stylesheet" as=style>
<link rel=icon href=https://antoniosbarotsis.github.io/Blog/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://antoniosbarotsis.github.io/Blog/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://antoniosbarotsis.github.io/Blog/favicon-32x32.png>
<link rel=apple-touch-icon href=https://antoniosbarotsis.github.io/Blog/apple-touch-icon.png>
<link rel=mask-icon href=https://antoniosbarotsis.github.io/Blog/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<meta property="og:title" content="C# and the ELK stack">
<meta property="og:description" content="Integrating the ELK stack with C#">
<meta property="og:type" content="article">
<meta property="og:url" content="https://antoniosbarotsis.github.io/Blog/posts/cs_elk/">
<meta property="og:image" content="https://antoniosbarotsis.github.io/Blog/images/elastic.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-28T22:04:54+02:00">
<meta property="article:modified_time" content="2021-10-28T22:04:54+02:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://antoniosbarotsis.github.io/Blog/images/elastic.png">
<meta name=twitter:title content="C# and the ELK stack">
<meta name=twitter:description content="Integrating the ELK stack with C#">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://antoniosbarotsis.github.io/Blog/posts/"},{"@type":"ListItem","position":2,"name":"C# and the ELK stack","item":"https://antoniosbarotsis.github.io/Blog/posts/cs_elk/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"C# and the ELK stack","name":"C# and the ELK stack","description":"Integrating the ELK stack with C#","keywords":["Csharp","Elasticsearch","Kibana","Monitoring"],"articleBody":"What is the ELK stack? With today’s applications growing in complexity rapidly, debugging and efficiently digesting logs have become crucial. That is the problem that the ELK stack is trying to solve.\nThe ELK stack consists of:\n Elasticsearch: A distributed search engine with highly refined analytics capabilities Logstash: A data-processing pipeline that collects data and delivers it to Elasticsearch Kibana: A visualization platform built expressly for Elasticsearch  These three together make for a great way of digesting aggregated logs from your application through visualisations.\nWhat will we be creating? We will be making a simple API (the default weather forecast template), have it produce logs using Serilog into elasticsearch and viewing them through kibana.\nFor this post I will be assuming you have used C# before and thus you have a ready-to-go set up on your machine.\nCoding Let’s first make our project using the dotnet cli, I will name mine elk\ndotnet new webapi -n elk Verify that everything is working fine by running the API\ndotnet run and visiting https://localhost:5001/weatherforecast. I am using Insomnia for my http client but Postman or your browser would also work.\nSetting up middleware I will be setting up middleware to handle logging as it is a cleaner solution than logging in each request. You can read more about middleware here.\nI created the following file:\n// MyMiddleware.cs using System.Threading.Tasks; using Microsoft.AspNetCore.Http; using Microsoft.Extensions.Logging; namespace elk { public class MyMiddleware { private readonly ILogger _logger; private readonly RequestDelegate _next; public MyMiddleware(RequestDelegate next, ILogger logger) { _next = next; _logger = logger; } public async Task InvokeAsync(HttpContext context) { _logger.LogInformation(\"Hello from middleware\"); await _next(context); } } } and added the following line to the Configure method in Startup.cs\n// Startup.cs - Configure app.UseMiddleware(); If we now run the app and make a request to our endpoint we can see Hello from middleware logged to the console.\nKnowing that that works lets change the middleware a bit so it can catch and handle exceptions\n// MyMiddleware.cs using System; using System.Threading.Tasks; using Microsoft.AspNetCore.Http; using Microsoft.AspNetCore.Mvc; using Microsoft.Extensions.Logging; namespace elk { public class MyMiddleware { private readonly ILogger _logger; private readonly RequestDelegate _next; public MyMiddleware(RequestDelegate next, ILogger logger) { _next = next; _logger = logger; } public async Task InvokeAsync(HttpContext context) { try { await _next(context); } catch (Exception exception) { _logger.LogError(exception, \"Something went wrong\"); await HandleExceptionAsync(context, exception); } } private static Task HandleExceptionAsync(HttpContext context, Exception ex) { context.Response.StatusCode = 500; return context.Response.WriteAsync(\"An exception occured\"); } } } If we now run the app again we should see nothing logged in the console. If we add a throw new Exception(); statement in our controller we should get a 500 Response back saying that an exception occured and also see the exception logged in the terminal.\nI am going to add the following to the controller so we get errors at random from the endpoint\nif (rng.Next(0, 10) 2) throw new Exception(); Setting up the Elasticsearch and Kibana containers I will be using Docker to run Elasticsearch and Kibana so first thing I want to do is make a docker-compose.yml file.\n# docker-compose.yml version: \"2.4\" services: es: image: docker.elastic.co/elasticsearch/elasticsearch:7.14.2 container_name: es ports: - \"9200:9200\" cpu_count: 1 mem_limit: 4g ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 environment: - cluster.name=es-docker - cluster.initial_master_nodes=node1 - node.name=node1 - bootstrap.memory_lock=true - \"ES_JAVA_OPTS=-Xms2g -Xmx2g\" kib: image: docker.elastic.co/kibana/kibana:7.14.2 container_name: kib ports: - \"5601:5601\" depends_on: - es cpu_count: 1 mem_limit: 4g environment: ELASTICSEARCH_URL: http://es:9200 ELASTICSEARCH_HOSTS: http://es:9200 A few things about this;\n It seems that at the time of writing this, version 3 does not support resource limits without using swarm hence the downgrade to 2.4 (please use resource limits if you want your computer to be usable) The cluster.initial_master_nodes and node.name must have the same value as I want to use a one node cluster The ELASTICSEARCH_URL and ELASTICSEARCH_HOSTS params are needed since by default these will try to find the elasticsearch server at http://localhost:9200.  Setting up Serilog We will be using the Serilog.AspNetCore (for logging), Serilog.Sinks.Elasticsearch (for pushing our logs to elastic) and Serilog.Enricher.Environment (for adding properties from System.Environment) packages.\nOnce you have those installed, go to the appsettings.json file, remove the Logging section and add the following:\n\"Serilog\": { \"MinimumLevel\": { \"Default\": \"Information\", \"Override\": { \"Microsoft\": \"Information\", \"System\": \"Warning\" } } } We need to make some changes in our Program.cs file both for logging in the terminal as well as pushing our logs to Elastic.\n// Program.cs public static IHostBuilder CreateHostBuilder(string[] args) { return Host.CreateDefaultBuilder(args) .UseSerilog((context, configuration) = { configuration .Enrich.FromLogContext() .Enrich.WithMachineName() .WriteTo.Console() .WriteTo.Elasticsearch( new ElasticsearchSinkOptions(new Uri(context.Configuration[\"ElasticConfig:url\"])) { IndexFormat = $\"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}-\" + $\"{context.Configuration[\"ASPNETCORE_ENVIRONMENT\"].ToLower()}_{DateTime.UtcNow:yyyy-MM-dd}\", AutoRegisterTemplate = true }) .Enrich.WithProperty(\"Environment\", context.HostingEnvironment.EnvironmentName) .ReadFrom.Configuration(context.Configuration); }) .ConfigureWebHostDefaults(webBuilder = { webBuilder.UseStartup(); }); } Most of this you can find online but for as a short explanation:\n We enrich our logs with the log context, machine name and the environment (dev/prod) We push our logs both to the console and to elastic The logs in elastic will have the format appname-dev/prod_date. Something to keep in mind for this is that it looks like some characters like : do not work in these patterns or at least didn’t work for me hence the underscore.  What’s cool about this is that we do not have to change our existing logger related code! We can also however use Serilog directly:\n Change the using Microsoft.Extensions.Logging; import to using Serilog; Remove the generic from the ILoggers Change _logger.LogError to _logger.Error  Another thing we can do is edit the Exception data and log some debugging critical parameter.\n// WeatherForecastController.cs if (rng.Next(0, 10) 2) { var myException = new Exception(); myException.Data.Add(\"someVeryImportantAttribute\", 42); throw myException; } // MyMiddleware.cs catch (Exception exception) { _logger.Error(exception, \"Something went wrong, {message}\", exception.Data[\"someVeryImportantAttribute\"]); await HandleExceptionAsync(context, exception); } If we now run the app logs will start getting pushed to elastic (make sure to also make a few requests so you get some errors!).\nKibana We can now visit http://localhost:5601 to access kibana.\nOnce there, go to Spaces  Manage Spaces from the top right and select default. On the left you should see Index patterns and if you go there you can essentially define the log pattern that you want kibana to consider, in my case that is elk-development_*. We can then go to Analytics  Discover and voilà!\nIf you made the Exception data change mentioned earlier you should be able to see that as well\nThe true power of this comes from how you can query your logs. You could for example query for level: Error to get all your error logs\nYou could also make queries like fields.ElapsedMilliseconds  10 or fields.RequestPath: /weatherforecast, you can read more about the possible queries here.\nOne thing I always love spending way too much time on is visualizations and I can definitely see this being the most powerful feature in Kibana\nConclusion Overall I think this was a pretty cool learning experience for me as I had never done proper error handling or used middleware before in C# (or used docker hardware limits but we do not talk about that). I think that although I definitely see the ELK stack being invaluable to a big company, I feel like I will not be using or recommend others to use if for small or personal projects as it is relatively hard to set up locally and expensive to host (especially if before this you just had a single app instance running).\nLong story short; it is definitely pretty cool but like normal logging should be enough for the majority of cases 👍.\nAnd of course by no means will implementing all of this compensate for bad error handling.\nThanks for reading!\nYou can find the code here.\n","wordCount":"1278","inLanguage":"en","image":"https://antoniosbarotsis.github.io/Blog/images/elastic.png","datePublished":"2021-10-28T22:04:54+02:00","dateModified":"2021-10-28T22:04:54+02:00","author":{"@type":"Person","name":"Antonios Barotsis"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://antoniosbarotsis.github.io/Blog/posts/cs_elk/"},"publisher":{"@type":"Organization","name":"My Blog","logo":{"@type":"ImageObject","url":"https://antoniosbarotsis.github.io/Blog/favicon.ico"}}}</script>
</head>
<body id=top>
<script>window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://antoniosbarotsis.github.io/Blog/ accesskey=h title="My Blog (Alt + H)">My Blog</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://antoniosbarotsis.github.io/Blog/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://antoniosbarotsis.github.io/Blog/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://antoniosbarotsis.github.io/Blog/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://antoniosbarotsis.github.io/Blog/>Home</a>&nbsp;»&nbsp;<a href=https://antoniosbarotsis.github.io/Blog/posts/>Posts</a></div>
<h1 class=post-title>
C# and the ELK stack
</h1>
<div class=post-description>
Integrating the ELK stack with C#
</div>
<div class=post-meta>October 28, 2021&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Antonios Barotsis&nbsp;|&nbsp;<a href="https://github.com/AntoniosBarotsis/Blog/tree/master/content
/
posts/cs_elk/index.md" rel="noopener noreferrer" target=_blank>Suggest Changes</a></div>
</header>
<figure class=entry-cover>
<img loading=lazy srcset="https://antoniosbarotsis.github.io/Blog/posts/cs_elk/images/elastic_huc9e850baa85214107214a6dcb118376d_71348_360x0_resize_box_3.png 360w ,https://antoniosbarotsis.github.io/Blog/posts/cs_elk/images/elastic_huc9e850baa85214107214a6dcb118376d_71348_480x0_resize_box_3.png 480w ,https://antoniosbarotsis.github.io/Blog/posts/cs_elk/images/elastic_huc9e850baa85214107214a6dcb118376d_71348_720x0_resize_box_3.png 720w ,https://antoniosbarotsis.github.io/Blog/posts/cs_elk/images/elastic_huc9e850baa85214107214a6dcb118376d_71348_1080x0_resize_box_3.png 1080w ,https://antoniosbarotsis.github.io/Blog/posts/cs_elk/images/elastic.png 1461w" sizes="(min-width: 768px) 720px, 100vw" src=https://antoniosbarotsis.github.io/Blog/posts/cs_elk/images/elastic.png alt>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>Table of Contents</div>
</summary>
<div class=inner><ul>
<li>
<a href=#what-is-the-elk-stack aria-label="What is the ELK stack?">What is the ELK stack?</a></li>
<li>
<a href=#what-will-we-be-creating aria-label="What will we be creating?">What will we be creating?</a></li>
<li>
<a href=#coding aria-label=Coding>Coding</a><ul>
<li>
<a href=#setting-up-middleware aria-label="Setting up middleware">Setting up middleware</a></li>
<li>
<a href=#setting-up-the-elasticsearch-and-kibana-containers aria-label="Setting up the Elasticsearch and Kibana containers">Setting up the Elasticsearch and Kibana containers</a></li>
<li>
<a href=#setting-up-serilog aria-label="Setting up Serilog">Setting up Serilog</a></li>
<li>
<a href=#kibana aria-label=Kibana>Kibana</a></li></ul>
</li>
<li>
<a href=#conclusion aria-label=Conclusion>Conclusion</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=what-is-the-elk-stack>What is the ELK stack?<a hidden class=anchor aria-hidden=true href=#what-is-the-elk-stack>#</a></h1>
<p>With today&rsquo;s applications growing in complexity rapidly, debugging and efficiently digesting logs have become crucial.
That is the problem that the <a href=https://www.elastic.co/what-is/elk-stack>ELK stack</a> is trying to solve.</p>
<p>The ELK stack consists of:</p>
<ul>
<li>Elasticsearch: A distributed search engine with highly refined analytics capabilities</li>
<li>Logstash: A data-processing pipeline that collects data and delivers it to Elasticsearch</li>
<li>Kibana: A visualization platform built expressly for Elasticsearch</li>
</ul>
<p>These three together make for a great way of digesting aggregated logs from your application through visualisations.</p>
<h1 id=what-will-we-be-creating>What will we be creating?<a hidden class=anchor aria-hidden=true href=#what-will-we-be-creating>#</a></h1>
<p>We will be making a simple API (the default weather forecast template), have it produce logs using Serilog into elasticsearch and viewing them
through kibana.</p>
<p>For this post I will be assuming you have used C# before and thus you have a ready-to-go set up on your machine.</p>
<h1 id=coding>Coding<a hidden class=anchor aria-hidden=true href=#coding>#</a></h1>
<p>Let&rsquo;s first make our project using the dotnet cli, I will name mine <code>elk</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dotnet new webapi -n elk
</code></pre></div><p>Verify that everything is working fine by running the API</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dotnet run
</code></pre></div><p>and visiting <code>https://localhost:5001/weatherforecast</code>. I am using <a href=https://insomnia.rest/>Insomnia</a> for my http client but Postman or your browser
would also work.</p>
<p><img loading=lazy src=images/helloWorld.jpg#center alt="image alt text">
</p>
<h2 id=setting-up-middleware>Setting up middleware<a hidden class=anchor aria-hidden=true href=#setting-up-middleware>#</a></h2>
<p>I will be setting up middleware to handle logging as it is a cleaner solution than logging in each request. You can read more about middleware
<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-5.0">here</a>.</p>
<p>I created the following file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// MyMiddleware.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Http;
<span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;

<span style=color:#66d9ef>namespace</span> elk
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyMiddleware</span>
    {
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger&lt;MyMiddleware&gt; <span style=color:#ae81ff>_l</span>ogger;
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> RequestDelegate <span style=color:#ae81ff>_</span>next;

        <span style=color:#66d9ef>public</span> MyMiddleware(RequestDelegate next, ILogger&lt;MyMiddleware&gt; logger)
        {
            <span style=color:#ae81ff>_</span>next = next;
            <span style=color:#ae81ff>_l</span>ogger = logger;
        }

        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task InvokeAsync(HttpContext context)
        {
            <span style=color:#ae81ff>_l</span>ogger.LogInformation(<span style=color:#e6db74>&#34;Hello from middleware&#34;</span>);
            <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>next(context);
        }
    }
}
</code></pre></div><p>and added the following line to the <code>Configure</code> method in <code>Startup.cs</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// Startup.cs -&gt; Configure
</span><span style=color:#75715e></span>app.UseMiddleware&lt;MyMiddleware&gt;();
</code></pre></div><p>If we now run the app and make a request to our endpoint we can see <code>Hello from middleware</code> logged to the console.</p>
<p>Knowing that that works lets change the middleware a bit so it can catch and handle exceptions</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// MyMiddleware.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Http;
<span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Mvc;
<span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;

<span style=color:#66d9ef>namespace</span> elk
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyMiddleware</span>
    {
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger&lt;MyMiddleware&gt; <span style=color:#ae81ff>_l</span>ogger;
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> RequestDelegate <span style=color:#ae81ff>_</span>next;

        <span style=color:#66d9ef>public</span> MyMiddleware(RequestDelegate next, ILogger&lt;MyMiddleware&gt; logger)
        {
            <span style=color:#ae81ff>_</span>next = next;
            <span style=color:#ae81ff>_l</span>ogger = logger;
        }

        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task InvokeAsync(HttpContext context)
        {
            <span style=color:#66d9ef>try</span>
            {
                <span style=color:#66d9ef>await</span> <span style=color:#ae81ff>_</span>next(context);
            }
            <span style=color:#66d9ef>catch</span> (Exception exception)
            {
                <span style=color:#ae81ff>_l</span>ogger.LogError(exception, <span style=color:#e6db74>&#34;Something went wrong&#34;</span>);
                
                <span style=color:#66d9ef>await</span> HandleExceptionAsync(context, exception);
            }
        }

        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Task HandleExceptionAsync(HttpContext context, Exception ex)
        {
            context.Response.StatusCode = <span style=color:#ae81ff>500</span>;
            <span style=color:#66d9ef>return</span> context.Response.WriteAsync(<span style=color:#e6db74>&#34;An exception occured&#34;</span>);
        }
    }
}
</code></pre></div><p>If we now run the app again we should see nothing logged in the console. If we add a <code>throw new Exception();</code> statement in our controller
we should get a <code>500</code> Response back saying that an exception occured and also see the exception logged in the terminal.</p>
<p>I am going to add the following to the controller so we get errors at random from the endpoint</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#66d9ef>if</span> (rng.Next(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>) &lt; <span style=color:#ae81ff>2</span>)
    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Exception();
</code></pre></div><h2 id=setting-up-the-elasticsearch-and-kibana-containers>Setting up the Elasticsearch and Kibana containers<a hidden class=anchor aria-hidden=true href=#setting-up-the-elasticsearch-and-kibana-containers>#</a></h2>
<p>I will be using Docker to run Elasticsearch and Kibana so first thing I want to do is make a <code>docker-compose.yml</code> file.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#75715e># docker-compose.yml</span>
<span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;2.4&#34;</span>
<span style=color:#f92672>services</span>:
  <span style=color:#f92672>es</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.elastic.co/elasticsearch/elasticsearch:7.14.2</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>es</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#e6db74>&#34;9200:9200&#34;</span>
    <span style=color:#f92672>cpu_count</span>: <span style=color:#ae81ff>1</span>
    <span style=color:#f92672>mem_limit</span>: <span style=color:#ae81ff>4g</span>
    <span style=color:#f92672>ulimits</span>:
      <span style=color:#f92672>memlock</span>:
        <span style=color:#f92672>soft</span>: -<span style=color:#ae81ff>1</span>
        <span style=color:#f92672>hard</span>: -<span style=color:#ae81ff>1</span>
      <span style=color:#f92672>nofile</span>:
        <span style=color:#f92672>soft</span>: <span style=color:#ae81ff>65536</span>
        <span style=color:#f92672>hard</span>: <span style=color:#ae81ff>65536</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>cluster.name=es-docker</span>
      - <span style=color:#ae81ff>cluster.initial_master_nodes=node1</span>
      - <span style=color:#ae81ff>node.name=node1</span>
      - <span style=color:#ae81ff>bootstrap.memory_lock=true</span>
      - <span style=color:#e6db74>&#34;ES_JAVA_OPTS=-Xms2g -Xmx2g&#34;</span>
  <span style=color:#f92672>kib</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.elastic.co/kibana/kibana:7.14.2</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>kib</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#e6db74>&#34;5601:5601&#34;</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>es</span>
    <span style=color:#f92672>cpu_count</span>: <span style=color:#ae81ff>1</span>
    <span style=color:#f92672>mem_limit</span>: <span style=color:#ae81ff>4g</span>
    <span style=color:#f92672>environment</span>: 
      <span style=color:#f92672>ELASTICSEARCH_URL</span>: <span style=color:#ae81ff>http://es:9200</span>
      <span style=color:#f92672>ELASTICSEARCH_HOSTS</span>: <span style=color:#ae81ff>http://es:9200</span>
</code></pre></div><p>A few things about this;</p>
<ul>
<li>It seems that at the time of writing this, version 3 does not support resource limits without using swarm hence the downgrade to 2.4
(please use resource limits if you want your computer to be usable)</li>
<li>The <code>cluster.initial_master_nodes</code> and <code>node.name</code> must have the same value as I want to use a one node cluster</li>
<li>The <code>ELASTICSEARCH_URL</code> and <code>ELASTICSEARCH_HOSTS</code> params are needed since by default these will try to find the elasticsearch server at
<code>http://localhost:9200</code>.</li>
</ul>
<h2 id=setting-up-serilog>Setting up Serilog<a hidden class=anchor aria-hidden=true href=#setting-up-serilog>#</a></h2>
<p>We will be using the <code>Serilog.AspNetCore</code> (for logging), <code>Serilog.Sinks.Elasticsearch</code> (for pushing our logs to elastic) and
<code>Serilog.Enricher.Environment</code> (for adding properties from System.Environment) packages.</p>
<p>Once you have those installed, go to the <code>appsettings.json</code> file, remove the Logging section and add the following:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#e6db74>&#34;Serilog&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
  <span style=color:#f92672>&#34;MinimumLevel&#34;</span>: {
    <span style=color:#f92672>&#34;Default&#34;</span>: <span style=color:#e6db74>&#34;Information&#34;</span>,
    <span style=color:#f92672>&#34;Override&#34;</span>: {
      <span style=color:#f92672>&#34;Microsoft&#34;</span>: <span style=color:#e6db74>&#34;Information&#34;</span>,
      <span style=color:#f92672>&#34;System&#34;</span>: <span style=color:#e6db74>&#34;Warning&#34;</span>
    }
  }
}
</code></pre></div><p>We need to make some changes in our <code>Program.cs</code> file both for logging in the terminal as well as pushing our logs to Elastic.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// Program.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IHostBuilder CreateHostBuilder(<span style=color:#66d9ef>string</span>[] args)
{
    <span style=color:#66d9ef>return</span> Host.CreateDefaultBuilder(args)
        .UseSerilog((context, configuration) =&gt;
        {
            configuration
                .Enrich.FromLogContext()
                .Enrich.WithMachineName()
                .WriteTo.Console()
                .WriteTo.Elasticsearch(
                    <span style=color:#66d9ef>new</span> ElasticsearchSinkOptions(<span style=color:#66d9ef>new</span> Uri(context.Configuration[<span style=color:#e6db74>&#34;ElasticConfig:url&#34;</span>]))
                    {
                        IndexFormat = <span style=color:#e6db74>$&#34;{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}-&#34;</span> +
                                      <span style=color:#e6db74>$&#34;{context.Configuration[&#34;</span>ASPNETCORE_ENVIRONMENT<span style=color:#e6db74>&#34;].ToLower()}_{DateTime.UtcNow:yyyy-MM-dd}&#34;</span>,
                        AutoRegisterTemplate = <span style=color:#66d9ef>true</span>
                    })
                .Enrich.WithProperty(<span style=color:#e6db74>&#34;Environment&#34;</span>, context.HostingEnvironment.EnvironmentName)
                .ReadFrom.Configuration(context.Configuration);
        })
        .ConfigureWebHostDefaults(webBuilder =&gt; { webBuilder.UseStartup&lt;Startup&gt;(); });
}
</code></pre></div><p>Most of this you can find online but for as a short explanation:</p>
<ul>
<li>We enrich our logs with the log context, machine name and the environment (dev/prod)</li>
<li>We push our logs both to the console and to elastic</li>
<li>The logs in elastic will have the format <code>appname-dev/prod_date</code>. Something to keep in mind for this is that it looks like some characters
like <code>:</code> do not work in these patterns or at least didn&rsquo;t work for me hence the underscore.</li>
</ul>
<p>What&rsquo;s cool about this is that we do not have to change our existing logger related code! We can also however use Serilog directly:</p>
<ul>
<li>Change the <code>using Microsoft.Extensions.Logging;</code> import to <code>using Serilog;</code></li>
<li>Remove the generic from the <code>ILogger</code>s</li>
<li>Change <code>_logger.LogError</code> to <code>_logger.Error</code></li>
</ul>
<p>Another thing we can do is edit the Exception data and log some debugging critical parameter.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// WeatherForecastController.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (rng.Next(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>) &lt; <span style=color:#ae81ff>2</span>)
{
    <span style=color:#66d9ef>var</span> myException = <span style=color:#66d9ef>new</span> Exception();
    myException.Data.Add(<span style=color:#e6db74>&#34;someVeryImportantAttribute&#34;</span>, <span style=color:#ae81ff>42</span>);
    <span style=color:#66d9ef>throw</span> myException;
}
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// MyMiddleware.cs
</span><span style=color:#75715e></span><span style=color:#66d9ef>catch</span> (Exception exception)
{
    <span style=color:#ae81ff>_l</span>ogger.Error(exception, <span style=color:#e6db74>&#34;Something went wrong, {message}&#34;</span>, exception.Data[<span style=color:#e6db74>&#34;someVeryImportantAttribute&#34;</span>]);
    
    <span style=color:#66d9ef>await</span> HandleExceptionAsync(context, exception);
}
</code></pre></div><p>If we now run the app logs will start getting pushed to elastic (make sure to also make a few requests so you get some errors!).</p>
<h2 id=kibana>Kibana<a hidden class=anchor aria-hidden=true href=#kibana>#</a></h2>
<p>We can now visit <code>http://localhost:5601</code> to access kibana.</p>
<p>Once there, go to <code>Spaces > Manage Spaces</code> from the top right and select default. On the left you should see <code>Index patterns</code> and if you go there
you can essentially define the log pattern that you want kibana to consider, in my case that is <code>elk-development_*</code>. We can then go to
<code>Analytics > Discover</code> and voilà!</p>
<p><img loading=lazy src=images/logs.jpg#center alt=logs>
</p>
<p>If you made the Exception data change mentioned earlier you should be able to see that as well</p>
<p><img loading=lazy src=images/data.jpg#center alt=data>
</p>
<p>The true power of this comes from how you can query your logs. You could for example query for <code>level: Error</code> to get all your error logs</p>
<p><img loading=lazy src=images/errors.jpg#center alt=logs>
</p>
<p>You could also make queries like <code>fields.ElapsedMilliseconds > 10</code> or <code>fields.RequestPath: /weatherforecast</code>, you can read more about the
possible queries <a href=https://www.elastic.co/guide/en/kibana/current/kuery-query.html>here</a>.</p>
<p>One thing I always love spending way too much time on is visualizations and I can definitely see this being the most powerful feature in
Kibana</p>
<p><img loading=lazy src=images/plots.jpg#center alt=plots>
</p>
<h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1>
<p>Overall I think this was a pretty cool learning experience for me as I had never done proper error handling or used middleware before in
C# (or used docker hardware limits but we do not talk about that). I think that although I definitely see the ELK stack being invaluable
to a big company, I feel like I will not be using or recommend others to use if for small or personal projects as it is relatively hard
to set up locally and expensive to host (especially if before this you just had a single app instance running).</p>
<p>Long story short; it is definitely pretty cool but like normal logging should be enough for the majority of cases 👍.</p>
<p>And of course by no means will implementing all of this compensate for bad error handling.</p>
<p>Thanks for reading!</p>
<p>You can find the code <a href=https://github.com/AntoniosBarotsis/elk>here</a>.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/csharp/>Csharp</a></li>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/elasticsearch/>Elasticsearch</a></li>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/kibana/>Kibana</a></li>
<li><a href=https://antoniosbarotsis.github.io/Blog/tags/monitoring/>Monitoring</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://antoniosbarotsis.github.io/Blog/posts/tidy_tuesday/netflix_titles/>
<span class=title>Next Page »</span>
<br>
<span>Netflix Titles</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share C# and the ELK stack on twitter" href="https://twitter.com/intent/tweet/?text=C%23%20and%20the%20ELK%20stack&url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f&hashtags=Csharp%2cElasticsearch%2cKibana%2cMonitoring"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share C# and the ELK stack on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f&title=C%23%20and%20the%20ELK%20stack&summary=C%23%20and%20the%20ELK%20stack&source=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share C# and the ELK stack on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f&title=C%23%20and%20the%20ELK%20stack"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share C# and the ELK stack on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share C# and the ELK stack on whatsapp" href="https://api.whatsapp.com/send?text=C%23%20and%20the%20ELK%20stack%20-%20https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share C# and the ELK stack on telegram" href="https://telegram.me/share/url?text=C%23%20and%20the%20ELK%20stack&url=https%3a%2f%2fantoniosbarotsis.github.io%2fBlog%2fposts%2fcs_elk%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://utteranc.es/client.js repo=AntoniosBarotsis/Blog issue-term=pathname label=Comment theme=github-dark crossorigin=anonymous async></script>
</article>
</main>
</body>
</html>